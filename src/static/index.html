<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PoW Buster is an optimized solver for browser-based PoW systems.">
    <title>PoW Buster</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <h1>PoW Buster</h1>
    <p>A fast, adversarially implemented mCaptcha/Anubis/go-away/Cap.js PoW solver.</p>

    <h1>How to use</h1>
    <p>
        Anubis/Go-away/Cerberus: You should find the challenge JSON in:
    <ul>
        <li>`head > script#anubis_challenge`</li>
        <li>`script#challenge-script[x-challenge]`</li>
        <li>a network request that ends with `/make-challenge`</li>
    </ul>
    Copy the challenge JSON and paste it into the textarea below.
    Characters before the first `{` and after the last `}` are ignored.
    <br>
    GoToSocial/Nollamas: You should find challenge in `section.nollamas` as HTML attributes. Transform it into JSON
    and paste it into the textarea below.
    <br>
    Response will be a single redirect URL provided in JavaScript format mirroring the official solver's behavior
    after a solution is found.
    </p>

    <h1>Expected Formats</h1>
    <ul>
        <li>
            Anubis (both forms are accepted):
            <ul>
                <li>
                    "fast" and "slow":
                    <code>{"rules":{"algorithm":"fast","difficulty":4,"report_as":4},"challenge":"xxxxxx"}</code>
                </li>
                <li>
                    "preact":
                    <code>{"rules":{"algorithm":"preact","difficulty":1,"report_as":1},"challenge":{"id":"xxxxxx","randomData":"yyyyyy"}}</code>
                </li>
            </ul>
        </li>
        <li>
            Go-away (Server-Side Only for now):
            <code>{"challenge":"000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f", "target": "000fff", "difficulty": 16}</code>
        </li>
        <li>
            CapJS (Server-Side Only for now):
            <ul>
                <li>
                    Typical salt:
                    <code>{"challenge":{"c":50,"s":32,"d":4},"token":"4b1b46efba002091eeff6cfb0a8c2210d4670d9ce013d6e773","expires":0}</code>
                <li>
                    Stretched salt (floating point numbers are expected behavior, server will accept them):
                    <code>{"challenge":{"c":50,"s":57,"d":4},"token":"4b1b46efba002091eeff6cfb0a8c2210d4670d9ce013d6e773","expires":0}</code>
                </li>
            </ul>
        </li>
        <li>
            Cerberus (Server-Side Only for now):
            <code>{"challenge":"8676e9cefd7605e746987bf31262846259c2e550d4e308f66b74cb06a722a6c8","difficulty":16,"nonce":90144522,"ts":1000000000,"signature":"e3cae2bc91a2f303d272ba748a2fe82835ab057e9ff00bacd67bec24e9ae387b810407af545a6589b7f421defead23b9bc6c5ccfd3125fe758819e4312b3a300"}</code>
        </li>
        <li>
            GoToSocial/Nollamas (Server-Side Only for now, requires AVX-512 for now), the solution for the following
            challenge is 498330:
            <code>{"nollamas_seed":"0f0314853c035207","nollamas_challenge":"9c1351f7b40f2babe4e1b02c481ec94a2e14d91164da0925ca03845035891271"}</code>
        </li>
    </ul>

    <h1>Request Form</h1>

    <form action="/solve" method="post">
        <br>
        <textarea id="challenge" name="challenge" rows="10" cols="80"></textarea>
        <br>
        <button id="solve" type="submit">Solve Server Side (NoJS friendly)</button>
        <button id="solve-wasm" type="button" disabled>Solve in WASM</button>
    </form>

    <div id="wasm-results">
        <h1>WASM Results</h1>

        <p>WASM Module Loaded? <span id="module-loaded-value">JavaScript Not Executed</span></p>

        <div id="wasm-results-inner" class="hidden">
            <p><span id="wasm-error-value"></span></p>
            <p>Attempted Nonces: <span id="attempted-nonces-value"></span></p>
            <p>Latency: <span id="latency-value"></span></p>
            <p>Hash Rate: <span id="hash-rate-value"></span></p>

            <p>Pass challenge link: <span id="pass-challenge-link-value"></span></p>
            <button id="copy-pass-challenge-link-button" type="button">Copy Pass Challenge Link</button>
        </div>
    </div>

    <footer>
        <p>NOTICE: this is a public service limited to manageable load and limited concurrency, please do not abuse it.
            Run it on your own server if you need more resources.
            <a href="https://github.com/eternal-flame-AD/pow-buster">Source Code</a>
        </p>
    </footer>

    <script type="module">
        import init, { solve_anubis_json } from "/pkg/pow_buster.js";

        let solver = null;
        let worker = null;
        let solutionResolver = null;

        const moduleLoadedEl = document.getElementById("module-loaded-value");
        const loadPromise = new Promise((resolve, reject) => {
            try {
                worker = new Worker("/worker.js", { type: "module" });

                worker.onmessage = (e) => {
                    switch (e.data.type) {
                        case "ready":
                            moduleLoadedEl.innerText = "YES (WebWorker)";
                            solver = (json) => {
                                return new Promise((resolve, reject) => {
                                    solutionResolver = resolve;
                                    worker.postMessage({
                                        type: "solve",
                                        json,
                                    });
                                });
                            };
                            resolve();
                            break;
                        case "solution":
                            solutionResolver({ ...e.data.solution, "method": "webworker" });
                            break;
                        case "error":
                            reject(e.data.message);
                            break;
                    }
                };
            } catch (e) {
                console.error("error loading solver with webworker", e);
                reject(e);
            }
        });

        try {
            await loadPromise;
        } catch (e) {
            console.error("error loading solver with webworker", e);
            try {
                init();
                moduleLoadedEl.innerText = "YES (Sync WASM)";
                solver = async (json) => {
                    return { ...solve_anubis_json(json), "method": "sync wasm" };
                };
            } catch (e) {
                moduleLoadedEl.innerText = "ERROR: " + e;
                throw e;
            }
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
        }

        const encoder = new TextEncoder();

        const wasmErrorEl = document.getElementById("wasm-error-value");
        const wasmResultsInnerEl = document.getElementById("wasm-results-inner");


        const passChallengeLinkEl = document.getElementById("pass-challenge-link-value");

        const copyPassChallengeLinkButton = document.getElementById("copy-pass-challenge-link-button");
        copyPassChallengeLinkButton.addEventListener("click", () => {
            copyToClipboard(passChallengeLinkEl.innerText);
        });

        const attemptedNoncesEl = document.getElementById("attempted-nonces-value");
        const latencyEl = document.getElementById("latency-value");
        const hashRateEl = document.getElementById("hash-rate-value");
        const challengeEl = document.getElementById("challenge");
        const passChallengeLink = document.getElementById("pass-challenge-link");

        function findJson(text) {
            try {
                let left = text.indexOf("{");
                let right = text.lastIndexOf("}");
                if (left < right) {
                    return text.slice(left, right + 1);
                }
                return null;
            } catch (e) {
                return null;
            }
        }

        const solveButton = document.getElementById("solve-wasm");
        solveButton.addEventListener("click", () => {
            let json = findJson(challengeEl.value);
            if (json) {
                solveButton.disabled = true;
                solveButton.innerText = "Busy...";
                const start = performance.now();
                console.log("solving anubis json", json);

                solver(json).then((result) => {
                    const end = performance.now();
                    const duration = end - start;

                    console.log("result", result);
                    console.log("duration", duration);

                    setTimeout(() => {
                        let finalUrl = "/.within.website/x/cmd/anubis/api/pass-challenge?elapsedTime=" + result.delay + "&response=" + result.response + "&nonce=" + result.nonce + "&redir=/";
                        console.log("final url", finalUrl);
                        passChallengeLinkEl.innerText = finalUrl;
                        attemptedNoncesEl.innerText = result.attempted_nonces;
                        hashRateEl.innerText = "N/A";
                        if (duration >= 50) {
                            latencyEl.innerText = duration.toFixed(1) + "ms";
                            hashRateEl.innerText = (Number(result.attempted_nonces) / duration / 1024).toFixed(3) + " MH/s";
                        } else {
                            latencyEl.innerText = "<50ms";
                        }
                        wasmResultsInnerEl.classList.remove("hidden");
                    }, Math.max(0, result.delay - duration));
                }).catch((e) => {
                    console.error("error in wasm solver", e);
                    wasmErrorEl.innerText = "ERROR: " + e;
                    wasmResultsInnerEl.classList.remove("hidden");
                }).finally(() => {
                    solveButton.disabled = false;
                    solveButton.innerText = "Solve in WASM";
                });
            }
        });
        solveButton.disabled = false;
    </script>
</body>

</html>